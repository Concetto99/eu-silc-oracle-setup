CREATE OR REPLACE VIEW VW_DATASET_CHILDREN_ANALYSIS_PARENTS AS
WITH CHILD_ANALYSIS AS (
select 
RB030 AS ID_PERSON,
HB030 AS ID_HOUSEHOLD,
RB090 AS SEX, -- 2 FEMALE 1 MALE 
2023 - RB080 AS AGE, -- AGE IN YEARS
CASE WHEN 
            2023 - RB080 <= 15 THEN '[0-15]' 
            WHEN 
            2023 - RB080 > 16 AND 2023 - RB080 <= 24 THEN '(15-24]' 
            WHEN 
            2023 - RB080 > 24 AND 2023 - RB080 <= 44 THEN '(24-44]' 
            WHEN 
            2023 - RB080 > 44 AND 2023 - RB080 <= 64 THEN '(44-64]'
            ELSE '64+' 
            END AS AGE_CLASS, -- CLASS OF AGE
CASE WHEN 
            2023 - RB080 <= 15 THEN 1 
            WHEN 
            2023 - RB080 > 16 AND 2023 - RB080 <= 24 THEN 2 
            WHEN 
            2023 - RB080 > 24 AND 2023 - RB080 <= 44 THEN 3 
            WHEN 
            2023 - RB080 > 44 AND 2023 - RB080 <= 64 THEN 4
            ELSE 5 
            END AS FLAG_CLASS, -- FLAG
CASE WHEN HB120 >= 6 THEN 6 ELSE HB120 END AS N_MEMBERS,
RL010, --	EDUCATION AT PRE-SCHOOL
RL020, --	EDUCATION AT COMPULSORY SCHOOL
RL030, --	CHILDCARE AT CENTRE-BASED SERVICES [OUTSIDE SCHOOL HOURS (BEFORE/AFTER)]
RL040, --	CHILDCARE AT DAY-CARE CENTRE
RL050, --	CHILDCARE BY A PROFESSIONAL CHILD-MINDER AT CHILD’S HOME OR AT CHILD-MINDER’S HOME
RL060, --	CHILDCARE BY GRAND-PARENTS HOUSEHOLD MEMBERS OTHER THAN PARENTS OTHER RELATIVES FRIENDS OR NEIGHBOURS
HY054G,	--FAMILY/CHILDREN-RELATED ALLOWANCE [NON-CONTRIBUTORY AND NON MEANS-TESTED]
HY053G,	--FAMILY/CHILDREN-RELATED ALLOWANCES [NON-CONTRIBUTORY AND MEANS-TESTED]
HY052G,	--FAMILY/CHILDREN-RELATED ALLOWANCES [CONTRIBUTORY AND NON MEANS-TESTED]
HY051G,	--FAMILY/CHILDREN-RELATED ALLOWANCES [CONTRIBUTORY AND MEANS-TESTED]
HY050N,	--FAMILY/CHILDREN-RELATED ALLOWANCES
HY020 AS HH_INCOME,	--TOTAL DISPOSABLE HOUSEHOLD INCOME
HY010 AS HH_GROSS_INCOME, --TOTAL HOUSEHOLD GROSS INCOME
ROUND ((RL070- 16114959)/(99834034639 - 16114959), 4) AS WEIGHT_CHILDCARE, --	CHILDRENS’ CROSS-SECTIONAL WEIGHT FOR CHILDCARE (MAX=99834034639, MIN=16114959); (X - 16114959)/(99834034639 - 16114959)
RB220,
RB230
from td_udb_cit23r R
LEFT OUTER JOIN td_udb_cit23h H
ON SUBSTR(R.RB030,1,8) = H.HB030
WHERE SUBSTR(RB030,1,8) IN (
                select DB030 from TD_UDB_cIT23D
                where DB040 = 'ITC' AND DB100 = 1
                )              
AND 2023 - RB080 <= 6
),
PARENTS AS (
SELECT
     PB030
    ,PL060 AS WORK_HOUR	--NUMBER OF HOURS USUALLY WORKED PER WEEK IN THE MAIN JOB Personal Data (P-file)
    ,PL051A	AS OCCUPATION --OCCUPATION IN MAIN JOB55 Personal Data (P-file)
    ,PL040A	AS EMPLOYMENT_STATUS --STATUS IN EMPLOYMENT (MAIN JOB) Personal Data (P-file)
    ,HY054G	--FAMILY/CHILDREN-RELATED ALLOWANCE [NON-CONTRIBUTORY AND NON MEANS-TESTED]
    ,HY053G	--FAMILY/CHILDREN-RELATED ALLOWANCES [NON-CONTRIBUTORY AND MEANS-TESTED]
    ,HY052G	--FAMILY/CHILDREN-RELATED ALLOWANCES [CONTRIBUTORY AND NON MEANS-TESTED]
    ,HY051G	--FAMILY/CHILDREN-RELATED ALLOWANCES [CONTRIBUTORY AND MEANS-TESTED]
    ,HY050N	--FAMILY/CHILDREN-RELATED ALLOWANCES
    ,HY020 AS HH_INCOME	--TOTAL DISPOSABLE HOUSEHOLD INCOME
    ,HY010 AS HH_GROSS_INCOME --TOTAL HOUSEHOLD GROSS INCOME
FROM td_udb_cit23p
INNER JOIN td_udb_cit23h
ON SUBSTR(PB030,1,8) = HB030
WHERE PB030 IN (
                SELECT RB220 FROM CHILD_ANALYSIS
                UNION
                SELECT RB230 FROM CHILD_ANALYSIS
                )
)
SELECT * FROM PARENTS;